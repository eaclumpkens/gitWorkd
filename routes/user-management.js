var path=require("path"),db=require("../models"),axios=require("axios");const{v4:uuidv4}=require("uuid"),consts=require("../utils/consts"),repo=require("../models/repo"),{unlink}=require("fs");function populateUserScores(a){var b={headers:{Authorization:`token ${a.accessToken}`}};console.log(b);var c=[],d=0,e=0;axios.get(consts.GITHUB_REPO_URL,b).then(f=>{var g=f.data;e=g.length;for(var h=0;h<g.length;h++)axios.get(g[h].languages_url,b).then(b=>{for(const a in console.log(b.data),b.data)c[a]||(c[a]=0),c[a]+=b.data[a];if(d++,d==e){var f=0,g=0;for(const a in c)f++,g+=c[a];for(const a in c)c[a]=100*(c[a]/g);var h={};for(const a in c){var i=a.replace(/\./g,"_");h[i]=c[a]}console.log("finished getting repos"),console.log(c),db.User.update(h,{where:{id:a.id},returning:!0,plain:!0}).then(a=>{console.log(a)})}}).catch(a=>{console.log("error getting repo langs"),console.log(a)})}).catch(a=>{console.log("Error getting repos"),console.log(a)})}module.exports=function(a){a.get("/api/gitRecieved",function(a,b){var c=a.query.code,d={client_secret:process.env.GITHUB_CLIENT_SECRET,client_id:process.env.GITHUB_CLIENT_ID,code:c};axios.post(consts.GITHUB_AUTH_URL,d).then(a=>{var c=a.data.substring(a.data.indexOf("=")+1,a.data.indexOf("&"));console.log("Access Token: "+c);axios.get(consts.GITHUB_USER_URL,{headers:{Authorization:`token ${c}`}}).then(a=>{console.log(a.data),console.log(a.headers);var d=uuidv4(),e=Date.now();db.User.findOrCreate({where:{githubId:a.data.id},defaults:{accessToken:c,cookie:d,cookieCreated:e}}).then(d=>{db.User.update({accessToken:c},{where:{githubId:a.data.id}}).then(()=>{console.log("updateToken")}),b.cookie("uuid",d[0].dataValues.cookie,{maxAge:consts.MAX_LOGIN_TIME}),b.status(200),d[1]?(setTimeout(()=>{b.redirect("/main")},2e3),populateUserScores(d[0].dataValues)):b.redirect("/main")})})}).catch(a=>{console.log("Error Authenticating User"),console.log(a),b.status(404),b.send("YOU FAILED!!!1!!!")})})};