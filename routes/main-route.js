var path=require("path"),fs=require("fs"),db=require("../models"),axios=require("axios");const{v4:uuidv4}=require("uuid"),consts=require("../utils/consts"),userRepos=require("./user-repos");var mockRepos=[{title:"Eat-Da-Burger",username:"nickelme",tech:"JavaScript, Handlebars, MySQL",compat:"100%",link:"https://www.google.com"},{title:"Note Taker",username:"eaclumpkens",tech:"JavaScript, Handlebars, MySQL",compat:"90%",link:"https://www.google.com"},{title:"Random Repo",username:"twkirkpatrick",tech:"JavaScript, Handlebars, MySQL",compat:"80%",link:"https://www.google.com"}],allLangs=[];module.exports=function(a){for(var b,c=fs.readFileSync("./languages.txt",{encoding:"utf8",flag:"r"}),d=c.split("\n"),e=0;e<d.length;e++)(b=d[e],b=b.replace(/\./g,"_"),""!=b)&&allLangs.push(b);a.get("/main",(a,b)=>{var c=[];a.cookies.uuid||b.redirect("/"),a.cookies.uuid&&db.User.findOne({where:{cookie:a.cookies.uuid}}).then(a=>{if(!a)return void b.redirect("/");var d=a.id;db.Repo.findAll({}).then(e=>{for(var f=0;f<e.length;f++)d!==e[f].dataValues.UserId&&(c.push(e[f].dataValues),console.log(e[f].dataValues.id));for(var g=[],h=c.length,j=0,k=0;k<c.length;k++){var l={},m=c[k].UserId;Object.entries(c[k]).forEach(([a,b])=>{null!==b&&(l[`${a}`]=`${b}`)});var n=c=>{var d=`${consts.GITHUB_REPO_BY_ID}${c.githubId}`;console.log(d);var e={headers:{Authorization:`token ${a.dataValues.accessToken}`}};axios.get(d,e).then(a=>{if(c.username=`${a.data.owner.login}`,c.avatar_url=`${a.data.owner.avatar_url}`,c.github_url=`${a.data.owner.html_url}`,c.repo_url=`${a.data.html_url}`,g.push(c),j++,j==h){for(var d,f=0;f<g.length;f++){d=[];for(var i=0;i<allLangs.length;i++)for(const a in g[f])allLangs[i]===a&&d.push(a);g[f].tech=d.join(", "),g[f].compat=Math.round(100*Math.random())+"%"}axios.get(consts.GITHUB_USER_URL,e).then(a=>{var c={pic:a.data.avatar_url,repoCount:a.data.public_repos,since:a.data.created_at.substring(0,a.data.created_at.indexOf("-")),name:a.data.login};console.log(g[0]),b.render("main-feed",{repos:g,user:c})})}})};n(l)}})})})};